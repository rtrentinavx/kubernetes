# GKE GitOps Solutions: ArgoCD vs Flux

This document provides a side-by-side comparison of the two GitOps solutions available for your GKE cluster.

## Quick Overview

| Aspect | ArgoCD | Flux v2 |
|--------|--------|---------|
| **Location** | `/gke/argocd/` | `/gke/flux/` |
| **Status** | Existing implementation | New alternative |
| **UI** | Built-in dashboards | Weave GitOps (included) |
| **Complexity** | Medium | Low |
| **Resource Usage** | ~500m CPU, 256Mi RAM | ~100m CPU, 64Mi RAM |
| **Git Sync** | Pull-based (webhooks optional) | Event-driven, pull-based |
| **SOPS Support** | Yes (via plugin) | Yes (native) |
| **Community** | Larger, more tools | Growing, CNCF graduated |

## Directory Comparison

### ArgoCD Structure (`/gke/argocd/`)
```
argocd/
├── providers.tf              # K8s, Helm providers + GCS backend
├── main.tf                   # ArgoCD Helm + static IP + root application
├── variables.tf              # Input variables
├── output.tf                 # Output values
├── data.tf                   # Data sources
├── terraform.tfvars          # Current values
└── terraform.tfvars.example  # Example template (if exists)
```

**Key Features:**
- Static external IP reservation for LoadBalancer
- ArgoCD root application for bootstrap
- Helm chart with applicationSet enabled

### Flux Structure (`/gke/flux/`)
```
flux/
├── providers.tf              # K8s, Helm, Google providers + GCS backend
├── main.tf                   # Flux + Weave GitOps Helm + static IP
├── variables.tf              # Input variables
├── output.tf                 # Output values
├── data.tf                   # Data sources
├── terraform.tfvars.example  # Example template
├── README.md                 # Complete deployment guide
└── .terraform/               # Working directory
```

**Key Features:**
- Flux v2 with GitRepository source
- Kustomization for GitOps
- Weave GitOps web UI
- Static external IP reservation
- GitHub token secret management

## Feature Comparison

### Deployment & Initial Setup

**ArgoCD:**
```bash
cd gke/argocd
cp terraform.tfvars.example terraform.tfvars  # if exists
terraform init
terraform plan
terraform apply
```

**Flux:**
```bash
cd gke/flux
cp terraform.tfvars.example terraform.tfvars
terraform init
terraform plan
terraform apply
```

### Web UI Access

**ArgoCD:**
```bash
# Get IP from terraform output
terraform output argocd_lb_ip

# Access at http://<IP>:80
# Login credentials are auto-generated by Helm chart
```

**Flux (via Weave GitOps):**
```bash
# Get IP and admin password
terraform output weave_access_url
terraform output -raw weave_admin_password

# Access at http://<IP>
# Username: admin
# Password: (from output above)
```

### Repository Configuration

**ArgoCD:**
```terraform
# In terraform.tfvars
gitops_repo_url = "https://github.com/rtrentinavx/k8sgitops.git"
gitops_repo_path = "applications/"
```

**Flux:**
```terraform
# In terraform.tfvars
github_owner = "rtrentinavx"
github_repo = "k8sgitops"
gitops_repo_path = "applications/"
```

Both automatically create the necessary resources to synchronize your repository.

### Monitoring & Troubleshooting

**ArgoCD:**
```bash
# Check ArgoCD server status
kubectl -n argocd get pods
kubectl -n argocd logs -f deployment/argocd-server

# View applications
kubectl -n argocd get applications
kubectl -n argocd describe application <app-name>

# Access web UI for complete visibility
```

**Flux:**
```bash
# Check Flux component status
kubectl -n flux-system get pods
kubectl -n flux-system logs -f deployment/source-controller

# Check synchronization status
flux status
flux status --verbose

# View GitRepository and Kustomization
kubectl -n flux-system get gitrepository
kubectl -n flux-system get kustomization
```

## Use Case Recommendations

### Choose **ArgoCD** if:
- ✅ Team prefers centralized UI with rich features
- ✅ You need native multi-cluster management
- ✅ Familiar with ArgoprojectCI/CD ecosystem
- ✅ Advanced policy management (RBAC, etc.) needed
- ✅ Extensive community plugins required

### Choose **Flux** if:
- ✅ Prefer lightweight, Kubernetes-native approach
- ✅ Want minimal resource footprint
- ✅ Value GitOps-first philosophy
- ✅ SOPS integration with native support
- ✅ Team familiar with pull-request based workflows

## Operational Differences

### Adding New Applications

**ArgoCD:**
1. Create Application manifest
2. Apply to cluster or push to repo
3. View in UI with automatic sync options

**Flux:**
1. Create Kubernetes resources (Deployments, Services, etc.)
2. Push to Git repository
3. Flux automatically detects and applies
4. Monitor via `flux status` or Weave UI

### Updating Existing Deployments

**ArgoCD:**
```bash
# Update via kubectl (not recommended)
kubectl -n argocd patch app myapp --type merge -p '...'

# Recommended: Update Git repository, ArgoCD syncs automatically
```

**Flux:**
```bash
# Force reconciliation if needed
flux reconcile source git my-repo
flux reconcile kustomization my-app

# Normal: Flux detects Git changes automatically
```

### Rollback Strategy

**ArgoCD:**
- UI provides one-click rollback to previous sync
- Maintains sync history with timestamps
- Can roll back to any previous Git commit

**Flux:**
- Git history is the source of truth
- Rollback via Git revert/reset
- GitOps manifesto approach

## State Management

**ArgoCD:**
- Maintains application sync state in cluster
- State includes deployment status, sync results
- Accessible via API and UI

**Flux:**
- Stateless design - Git is the source of truth
- Status stored in Kubernetes objects (GitRepository, Kustomization)
- Event-driven reconciliation

## Customization & Extension

**ArgoCD:**
```terraform
# Helm values allow extensive customization
values = [yamlencode({
  server = { ... }
  controller = { ... }
  redis = { ... }
  # ... many other options
})]
```

**Flux:**
```terraform
# Flux Helm chart is lighter with fewer customization points
# Additional customization via FluxCD CRDs (GitRepository, Kustomization)
values = [yamlencode({
  namespace = "flux-system"
  # ... core options
})]
```

## Migration Path

If you want to switch from ArgoCD to Flux (or vice versa):

1. **Export current state:**
   ```bash
   # ArgoCD
   kubectl -n argocd get applications -A -o yaml > apps.yaml
   
   # Flux
   kubectl -n flux-system get gitrepository,kustomization -o yaml > flux.yaml
   ```

2. **Convert manifests** to target platform format

3. **Deploy alternative** alongside existing solution

4. **Migrate traffic** and validate

5. **Remove old solution:**
   ```bash
   cd gke/argocd  # or gke/flux
   terraform destroy
   ```

## Performance Comparison

| Metric | ArgoCD | Flux v2 |
|--------|--------|---------|
| **Memory Usage** | 256Mi+ | 64Mi-128Mi |
| **CPU Usage** | 500m+ | 100m-200m |
| **Sync Interval** | Configurable, default 3min | Configurable, default 1min |
| **API Requests** | Continuous state polling | Event-driven |
| **Scaling** | Fine for 100s of apps | Excellent even with 1000s |

## Support & Documentation

**ArgoCD:**
- [Official Documentation](https://argo-cd.readthedocs.io/)
- [GitHub Repository](https://github.com/argoproj/argo-cd)
- Large community, many third-party tools

**Flux:**
- [Official Documentation](https://fluxcd.io/docs/)
- [GitHub Repository](https://github.com/fluxcd/flux2)
- [CNCF Graduated Project](https://www.cncf.io/projects/flux/)
- Growing ecosystem

## Next Steps

### To Deploy ArgoCD
```bash
cd /Users/ricardotrentin/Documents/2025/kuburnetes/gke/argocd
# Follow existing setup
```

### To Deploy Flux
```bash
cd /Users/ricardotrentin/Documents/2025/kuburnetes/gke/flux
# See README.md for complete deployment guide
```

### To Run Both (for evaluation)
It's possible to run both solutions simultaneously:
- ArgoCD in `argocd` namespace
- Flux in `flux-system` namespace
- Different kubeconfig contexts or separate clusters

This allows team evaluation before choosing one solution.

## Cost Implications

- **ArgoCD**: ~0.5 CPU, 256Mi RAM = ~$15-20/month
- **Flux**: ~0.2 CPU, 64Mi RAM = ~$5-10/month
- Both support the same underlying infrastructure costs

Choose based on features needed, not cost difference.

## Decision Matrix

| Requirement | ArgoCD | Flux | Score |
|-------------|--------|------|-------|
| Simplicity | Medium | High | Flux +1 |
| Feature Richness | High | Medium | ArgoCD +1 |
| Resource Efficient | Medium | High | Flux +1 |
| Team Familiarity | Check your team | Check your team | Varies |
| Enterprise Features | High | Growing | ArgoCD +1 |
| CNCF Alignment | Community project | Graduated | Flux +1 |

---

**Recommendation**: Start with your team's preference and experience. Both are excellent solutions. Flux is simpler and lighter; ArgoCD is feature-rich with more tooling.
